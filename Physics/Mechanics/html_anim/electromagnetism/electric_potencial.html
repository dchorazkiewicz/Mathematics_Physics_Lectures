
<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Import Plotly -->
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
</head>
<body>


<!-- Electric Potential & Work Explorer -->
<!-- Isolated Widget v6: Detailed Calculation Breakdown (Path vs Potential) -->

<div id="wp-widget-root">
    <style>
        /* ISOLATION RESET */
        #wp-widget-root {
            all: initial;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #ffffff;
            color: #1e293b;
            width: 100%;
            height: 750px; /* Zwiększona wysokość dla detali */
            display: flex;
            flex-direction: column;
            border: 1px solid #cbd5e1;
            border-radius: 8px;
            overflow: hidden;
            box-sizing: border-box;
            position: relative;
            margin: 20px 0;
        }

        #wp-widget-root * { box-sizing: border-box; }

        /* HEADER */
        #wp-widget-root .header {
            background-color: #f8fafc;
            border-bottom: 1px solid #e2e8f0;
            padding: 12px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        #wp-widget-root h2 {
            margin: 0; font-size: 1.1rem; font-weight: 700; color: #0f172a;
        }

        #wp-widget-root .scenario-btns {
            display: flex; gap: 6px;
        }

        #wp-widget-root button {
            background-color: #fff; border: 1px solid #cbd5e1; color: #475569;
            padding: 6px 12px; border-radius: 6px; font-size: 0.8rem;
            font-weight: 600; cursor: pointer; transition: all 0.2s; font-family: inherit;
        }
        #wp-widget-root button:hover { background-color: #f1f5f9; color: #0f172a; }
        #wp-widget-root button.active { background-color: #e0f2fe; border-color: #3b82f6; color: #0369a1; }

        #wp-widget-root button.action { background-color: #f1f5f9; }
        #wp-widget-root button.action:hover { background-color: #e2e8f0; }

        /* MAIN LAYOUT */
        #wp-widget-root .main-area {
            display: flex; flex-grow: 1; height: 100%; overflow: hidden;
        }

        /* CANVAS */
        #wp-widget-root .canvas-container {
            flex-grow: 1; position: relative; background-color: #ffffff;
            cursor: crosshair; overflow: hidden;
        }
        #wp-widget-root canvas { display: block; width: 100%; height: 100%; }

        /* SIDEBAR */
        #wp-widget-root .sidebar {
            width: 340px; background-color: #f8fafc; border-left: 1px solid #e2e8f0;
            padding: 16px; display: flex; flex-direction: column; gap: 12px; overflow-y: auto;
        }

        /* CARDS */
        #wp-widget-root .data-card {
            background: #fff; border: 1px solid #e2e8f0; border-radius: 8px;
            padding: 12px; box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }

        #wp-widget-root .card-title {
            font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.05em;
            color: #64748b; font-weight: 700; margin-bottom: 8px;
            border-bottom: 1px solid #f1f5f9; padding-bottom: 4px;
        }

        /* CALCULATION DETAILS */
        #wp-widget-root .calc-section {
            margin-bottom: 12px;
            padding-bottom: 12px;
            border-bottom: 1px dashed #e2e8f0;
        }
        #wp-widget-root .calc-section:last-child { border-bottom: none; margin-bottom: 0; padding-bottom: 0; }

        #wp-widget-root .calc-header {
            font-size: 0.8rem; font-weight: 700; margin-bottom: 4px; display: flex; justify-content: space-between;
        }

        #wp-widget-root .math-row {
            font-family: 'Georgia', serif; font-style: italic; color: #475569;
            font-size: 0.85rem; margin-bottom: 6px;
        }

        #wp-widget-root .detail-row {
            display: flex; justify-content: space-between; font-size: 0.8rem; color: #64748b; margin-bottom: 2px;
        }
        #wp-widget-root .detail-val { font-family: monospace; color: #334155; }

        #wp-widget-root .result-row {
            display: flex; justify-content: space-between; align-items: center;
            margin-top: 6px; font-weight: 600; font-size: 0.9rem;
        }

        #wp-widget-root .res-val { font-family: 'Courier New', monospace; font-weight: 700; font-size: 1rem; }

        /* LEGEND */
        #wp-widget-root .legend-item {
            display: flex; align-items: center; gap: 8px; font-size: 0.8rem;
            color: #475569; margin-bottom: 4px;
        }
        #wp-widget-root .dot { width: 10px; height: 10px; border-radius: 50%; }
        #wp-widget-root .line { width: 20px; height: 3px; border-radius: 2px; }

        /* SLIDERS */
        #wp-widget-root input[type=range] { width: 100%; margin: 8px 0; cursor: pointer; }

        #wp-widget-root .hint {
            position: absolute; bottom: 10px; left: 10px;
            font-size: 0.8rem; color: #64748b; background: rgba(255,255,255,0.95);
            padding: 6px 12px; border-radius: 4px; pointer-events: none;
            border: 1px solid #e2e8f0; box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
    </style>

    <div class="header">
        <h2>Potential & Work</h2>
        <div class="scenario-btns">
            <button onclick="WP_APP.setScenario('single', this)" class="active">Single</button>
            <button onclick="WP_APP.setScenario('dipole', this)">Dipole</button>
            <button onclick="WP_APP.setScenario('quad', this)">Square</button>
            <button onclick="WP_APP.setScenario('random', this)">Random</button>
        </div>
        <div class="scenario-btns">
            <button onclick="WP_APP.toggleField()" id="btn-field" class="action">Hide Field</button>
            <button onclick="WP_APP.resetPath()" class="action">Clear Path</button>
        </div>
    </div>

    <div class="main-area">
        <div class="canvas-container" id="wp-canvas-container">
            <canvas id="wp-canvas"></canvas>
            <div class="hint">
                Drag the yellow charge <b>(q)</b> to calculate Work
            </div>
        </div>

        <div class="sidebar">

            <!-- Physics Calculation Card -->
            <div class="data-card">
                <div class="card-title">Work Calculation Comparison</div>

                <!-- Method 1 -->
                <div class="calc-section">
                    <div class="calc-header" style="color:#d97706;">Method 1: Path Integral</div>
                    <div class="math-row">W = &int; <b>F</b> &middot; d<b>r</b></div>
                    <div class="detail-row">
                        <span>Summing force along path...</span>
                        <span class="detail-val" id="val-samples">0 steps</span>
                    </div>
                    <div class="result-row" style="color:#d97706;">
                        <span>Result:</span>
                        <span id="val-w-path" class="res-val">0.00 J</span>
                    </div>
                </div>

                <!-- Method 2 -->
                <div class="calc-section">
                    <div class="calc-header" style="color:#059669;">Method 2: Potential Diff.</div>
                    <div class="math-row">W = -q (V<sub>end</sub> - V<sub>start</sub>)</div>

                    <div class="detail-row">
                        <span>Start Potential (V<sub>start</sub>):</span>
                        <span id="val-v-start" class="detail-val">0.00 V</span>
                    </div>
                    <div class="detail-row">
                        <span>End Potential (V<sub>end</sub>):</span>
                        <span id="val-v-curr" class="detail-val">0.00 V</span>
                    </div>
                    <div class="detail-row">
                        <span>Test Charge (q):</span>
                        <span id="val-q-display" class="detail-val">1.00</span>
                    </div>

                    <div class="result-row" style="color:#059669;">
                        <span>Result:</span>
                        <span id="val-w-pot" class="res-val">0.00 J</span>
                    </div>
                </div>

                <div style="font-size:0.75rem; text-align:center; color:#64748b; margin-top:8px;">
                    Both methods must yield the same result.
                </div>
            </div>

            <!-- Controls -->
            <div class="data-card">
                <div class="card-title">Test Charge (q)</div>
                <input type="range" id="inp-q" min="-2" max="2" step="0.1" value="1">
                <div style="font-size:0.75rem; color:#64748b; text-align:right;">
                    Adjust q value
                </div>
            </div>

            <!-- Legend -->
            <div class="data-card">
                <div class="card-title">Legend</div>
                <div class="legend-item"><div class="dot" style="background:#ef4444;"></div> Positive Source</div>
                <div class="legend-item"><div class="dot" style="background:#3b82f6;"></div> Negative Source</div>
                <div class="legend-item"><div class="line" style="background:#ef4444;"></div> +W (Against Field)</div>
                <div class="legend-item"><div class="line" style="background:#22c55e;"></div> -W (With Field)</div>
            </div>

        </div>
    </div>

    <script>
    var WP_APP = (function() {
        var root = document.getElementById('wp-widget-root');
        var canvas = document.getElementById('wp-canvas');
        var ctx = canvas.getContext('2d');
        var container = document.getElementById('wp-canvas-container');

        // UI
        var ui = {
            wPath: document.getElementById('val-w-path'),
            wPot: document.getElementById('val-w-pot'),
            vCurr: document.getElementById('val-v-curr'),
            vStart: document.getElementById('val-v-start'),
            qDisp: document.getElementById('val-q-display'),
            samples: document.getElementById('val-samples'),
            inpq: document.getElementById('inp-q'),
            btnField: document.getElementById('btn-field')
        };

        // State
        var state = {
            w: 800, h: 600,
            sources: [], // {x, y, q}
            testQ: 1.0,
            pos: {x: 400, y: 300},

            // Interaction
            dragging: false,
            path: [], // {x,y, wDelta}

            // Physics
            startPot: 0,
            currentPot: 0,
            workPathAccum: 0,
            totalSamples: 0,
            stepSize: 0.5, // Always high precision (0.5px)

            showField: true,
            scale: 50, // pixels per unit
            K: 5000 // Display constant
        };

        function init() {
            resize();
            setScenario('single');

            // Listeners
            var resizeTimeout;
            new ResizeObserver(function() {
                if (resizeTimeout) clearTimeout(resizeTimeout);
                resizeTimeout = setTimeout(resize, 100);
            }).observe(container);

            canvas.addEventListener('mousedown', onDown);
            canvas.addEventListener('mousemove', onMove);
            window.addEventListener('mouseup', onUp);

            canvas.addEventListener('touchstart', function(e){e.preventDefault(); onDown(e.touches[0]);}, {passive:false});
            canvas.addEventListener('touchmove', function(e){e.preventDefault(); onMove(e.touches[0]);}, {passive:false});
            window.addEventListener('touchend', onUp);

            ui.inpq.oninput = function() {
                state.testQ = parseFloat(this.value);
                updatePhysics();
                draw();
            };

            loop();
        }

        function resize() {
            var r = container.getBoundingClientRect();
            if (Math.abs(state.w - r.width) < 1 && Math.abs(state.h - r.height) < 1) return;

            state.w = r.width; state.h = r.height;
            canvas.width = state.w; canvas.height = state.h;

            if(state.sources.length === 0) setScenario('single');
            else draw();
        }

        // --- Scenarios ---
        function setScenario(type, btn) {
            var cx = state.w / 2;
            var cy = state.h / 2;

            state.sources = [];

            if (type === 'single') {
                state.sources.push({x: cx, y: cy, q: 2});
            } else if (type === 'dipole') {
                state.sources.push({x: cx - 100, y: cy, q: 2});
                state.sources.push({x: cx + 100, y: cy, q: -2});
            } else if (type === 'quad') {
                var d = 80;
                state.sources.push({x: cx-d, y: cy-d, q: 2});
                state.sources.push({x: cx+d, y: cy-d, q: -2});
                state.sources.push({x: cx+d, y: cy+d, q: 2});
                state.sources.push({x: cx-d, y: cy+d, q: -2});
            } else if (type === 'random') {
                for(var i=0; i<3; i++) {
                    state.sources.push({
                        x: cx + (Math.random()-0.5)*300,
                        y: cy + (Math.random()-0.5)*200,
                        q: (Math.random() > 0.5 ? 1 : -1) * (1 + Math.random()*2)
                    });
                }
            }

            state.pos = {x: cx, y: cy + 150};
            state.path = [];
            state.workPathAccum = 0;
            state.totalSamples = 0;
            state.startPot = calcPot(state.pos.x, state.pos.y);

            if(btn) {
                var btns = root.querySelectorAll('.scenario-btns button');
                btns.forEach(function(b){ b.classList.remove('active'); });
                btn.classList.add('active');
            }

            updatePhysics();
            draw();
        }

        // --- Physics ---
        var MIN_R = 10;

        function calcPot(x, y) {
            var V = 0;
            for(var i=0; i<state.sources.length; i++) {
                var s = state.sources[i];
                var dx = x - s.x; var dy = y - s.y;
                var r = Math.sqrt(dx*dx + dy*dy);
                if (r < MIN_R) r = MIN_R;
                V += (state.K/10) * s.q / r;
            }
            return V;
        }

        function calcForce(x, y) {
            var Fx = 0; var Fy = 0;
            for(var i=0; i<state.sources.length; i++) {
                var s = state.sources[i];
                var dx = x - s.x; var dy = y - s.y;
                var r2 = dx*dx + dy*dy;
                var r = Math.sqrt(r2);
                if (r < MIN_R) r = MIN_R;

                var mag = state.K * s.q * state.testQ / (r*r);
                Fx += mag * (dx/r);
                Fy += mag * (dy/r);
            }
            return {x: Fx, y: Fy};
        }

        function updatePhysics() {
            state.currentPot = calcPot(state.pos.x, state.pos.y);

            // W = -q(V_end - V_start)
            var W_pot = -state.testQ * (state.currentPot - state.startPot);

            // Update UI
            ui.wPath.innerText = state.workPathAccum.toFixed(2) + " J";
            ui.wPot.innerText = W_pot.toFixed(2) + " J";

            ui.vCurr.innerText = state.currentPot.toFixed(2) + " V";
            ui.vStart.innerText = state.startPot.toFixed(2) + " V";
            ui.qDisp.innerText = state.testQ.toFixed(2);
            ui.samples.innerText = state.totalSamples + " steps";
        }

        // --- Interaction ---
        function onDown(e) {
            var r = canvas.getBoundingClientRect();
            var mx = e.clientX - r.left; var my = e.clientY - r.top;

            var dx = mx - state.pos.x; var dy = my - state.pos.y;
            if (dx*dx+dy*dy < 900) {
                state.dragging = true;
                state.startPot = calcPot(state.pos.x, state.pos.y);
                state.workPathAccum = 0;
                state.totalSamples = 0;
                state.path = [{x: state.pos.x, y: state.pos.y, w:0}];
                updatePhysics();
                draw();
            }
        }

        function onMove(e) {
            if(!state.dragging) return;
            var r = canvas.getBoundingClientRect();
            var mx = e.clientX - r.left; var my = e.clientY - r.top;

            mx = Math.max(10, Math.min(state.w-10, mx));
            my = Math.max(10, Math.min(state.h-10, my));

            // Integrate High Precision
            var startX = state.pos.x;
            var startY = state.pos.y;

            var distSq = (mx - startX)*(mx - startX) + (my - startY)*(my - startY);
            var dist = Math.sqrt(distSq);

            if (dist < 0.1) return;

            var steps = Math.ceil(dist / state.stepSize);
            var dX_step = (mx - startX) / steps;
            var dY_step = (my - startY) / steps;

            var accumWork = 0;
            var currX = startX;
            var currY = startY;

            for(var i=0; i<steps; i++) {
                var midX = currX + dX_step/2;
                var midY = currY + dY_step/2;

                var F = calcForce(midX, midY);
                accumWork += (F.x * dX_step + F.y * dY_step) / 10;

                currX += dX_step;
                currY += dY_step;
                state.totalSamples++;
            }

            state.workPathAccum += accumWork;
            state.pos = {x: mx, y: my};
            state.path.push({x: mx, y: my, w: accumWork});

            updatePhysics();
            draw();
        }

        function onUp() {
            state.dragging = false;
        }

        function resetPath() {
            state.path = [];
            state.workPathAccum = 0;
            state.totalSamples = 0;
            state.startPot = calcPot(state.pos.x, state.pos.y);
            updatePhysics();
            draw();
        }

        function toggleField() {
            state.showField = !state.showField;
            ui.btnField.innerText = state.showField ? "Hide Field" : "Show Field";
            draw();
        }

        // --- Render ---
        function draw() {
            ctx.clearRect(0,0,state.w, state.h);

            if(state.showField) drawField();
            drawEquipotentials();
            drawPath();
            drawSources();
            drawTestCharge();
        }

        function drawField() {
            ctx.strokeStyle = "rgba(148, 163, 184, 0.3)";
            ctx.lineWidth = 1;
            var step = 40;

            for(var x=20; x<state.w; x+=step) {
                for(var y=20; y<state.h; y+=step) {
                    var F = calcForce(x,y);
                    var mag = Math.sqrt(F.x*F.x + F.y*F.y);
                    if(mag < 0.1) continue;
                    var len = Math.min(20, mag*5);
                    var ux = F.x/mag; var uy = F.y/mag;

                    ctx.beginPath();
                    ctx.moveTo(x - ux*len/2, y - uy*len/2);
                    ctx.lineTo(x + ux*len/2, y + uy*len/2);
                    ctx.stroke();

                    var hx = x + ux*len/2; var hy = y + uy*len/2;
                    ctx.beginPath();
                    ctx.arc(hx, hy, 1.5, 0, 6.28);
                    ctx.fillStyle = "rgba(148, 163, 184, 0.8)";
                    ctx.fill();
                }
            }
        }

        function drawEquipotentials() {
            if (state.sources.length === 1) {
                ctx.strokeStyle = "rgba(100, 116, 139, 0.2)";
                ctx.setLineDash([4,4]);
                var s = state.sources[0];
                for(var r=50; r<600; r+=50) {
                    ctx.beginPath();
                    ctx.arc(s.x, s.y, r, 0, 6.28);
                    ctx.stroke();
                }
                ctx.setLineDash([]);
            }
        }

        function drawSources() {
            state.sources.forEach(function(s){
                ctx.beginPath();
                ctx.arc(s.x, s.y, 18, 0, 6.28);
                ctx.fillStyle = s.q > 0 ? "#ef4444" : "#3b82f6";
                ctx.fill();
                ctx.lineWidth=2; ctx.strokeStyle="white"; ctx.stroke();

                ctx.fillStyle="white"; ctx.textAlign="center"; ctx.textBaseline="middle";
                ctx.font="bold 14px Arial";
                ctx.fillText(s.q > 0 ? "+" : "-", s.x, s.y);
            });
        }

        function drawTestCharge() {
            var x = state.pos.x; var y = state.pos.y;

            if(state.path.length > 0) {
                var sx = state.path[0].x; var sy = state.path[0].y;
                ctx.beginPath(); ctx.arc(sx, sy, 4, 0, 6.28);
                ctx.fillStyle="#94a3b8"; ctx.fill();
                ctx.fillStyle="#64748b"; ctx.font="10px Arial";
                ctx.fillText("Start", sx, sy-10);
            }

            ctx.beginPath();
            ctx.arc(x, y, 12, 0, 6.28);
            var col = state.testQ > 0 ? "#facc15" : (state.testQ < 0 ? "#3b82f6" : "#94a3b8");
            ctx.fillStyle = col;

            if(state.dragging) {
                ctx.shadowColor="rgba(0,0,0,0.2)"; ctx.shadowBlur=10;
            }
            ctx.fill(); ctx.shadowBlur=0;
            ctx.strokeStyle="#475569"; ctx.lineWidth=2; ctx.stroke();

            ctx.fillStyle="#1e293b"; ctx.font="bold 11px Arial";
            ctx.fillText("q", x, y);
        }

        function drawPath() {
            if(state.path.length < 2) return;
            ctx.lineWidth = 4;
            ctx.lineCap = "round";

            for(var i=1; i<state.path.length; i++) {
                var p1 = state.path[i-1];
                var p2 = state.path[i];

                ctx.beginPath();
                ctx.moveTo(p1.x, p1.y);
                ctx.lineTo(p2.x, p2.y);

                if (p2.w > 0.05) ctx.strokeStyle = "#22c55e";
                else if (p2.w < -0.05) ctx.strokeStyle = "#ef4444";
                else ctx.strokeStyle = "#cbd5e1";

                ctx.stroke();
            }
        }

        function loop() { requestAnimationFrame(loop); }

        return {
            init: init,
            setScenario: setScenario,
            resetPath: resetPath,
            toggleField: toggleField,
            reset: function() { setScenario('single'); }
        };
    })();

    WP_APP.init();
    </script>
</div>

</body>
</html>
